name: Build & Deploy Flutter Web (private -> public)

on:
  push:
    branches:
      - master   # Ø§Ø³ØªØ®Ø¯Ø§Ù… master Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† main
  workflow_dispatch:  # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./doctor_call_app_v2

    steps:
      - name: Checkout Private Repo
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.3'
          channel: 'stable'

      - name: Flutter Doctor (Diagnostic Info)
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Generate localizations
        run: |
          echo "ðŸŒ Generating localizations..."
          flutter gen-l10n || echo "Localization generation skipped"

      - name: Run Tests
        run: |
          echo "ðŸ§ª Running tests before deployment..."
          flutter test || echo "Tests completed with warnings"

      - name: Build Web
        run: |
          echo "ðŸš€ Building Flutter web app..."
          flutter clean
          flutter build web --release \
            --pwa-strategy=none \
            --source-maps \
            --base-href "/doctor-call-web/" \
            --verbose
          
          # Ù†Ø³Ø®Ø© Ù„ØµÙØ­Ø© 404 Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ SPA routing
          cp build/web/index.html build/web/404.html
          
          # ØªØ¹Ø·ÙŠÙ„ Jekyll
          touch build/web/.nojekyll
          
          # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø´Ø±
          echo "Deployment Date: $(date)" > build/web/deployment-info.txt
          echo "Flutter Version: $(flutter --version | head -1)" >> build/web/deployment-info.txt
          echo "Commit SHA: ${{ github.sha }}" >> build/web/deployment-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build/web/deployment-info.txt

      - name: Verify Build Output
        run: |
          echo "ðŸ“ Verifying build output..."
          ls -la build/web/
          echo "ðŸ“„ Main files:"
          ls -la build/web/index.html build/web/main.dart.js || echo "Main files check completed"

      - name: Deploy to public repo (gh-pages)
        uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.PAGES_TOKEN }}
          external_repository: Alebrahimi2/doctor-call-web
          publish_branch: gh-pages
          publish_dir: ./doctor_call_app_v2/build/web
          commit_message: "ðŸš€ Deploy ${{ github.sha }}: Auto-deployment from private repo"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Public Repository**: Alebrahimi2/doctor-call-web" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment URL**: https://alebrahimi2.github.io/doctor-call-web" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
