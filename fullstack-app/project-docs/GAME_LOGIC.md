# منطق اللعبة بالتفصيل الممل

## 1. تسجيل الدخول (Login)
- المستخدم يدخل البريد وكلمة المرور في الواجهة.
- يتم إرسال طلب POST إلى `/api/login`.
- إذا كانت البيانات صحيحة:
  - يرجع الباك توكن JWT (Sanctum Personal Access Token).
  - يتم حفظ التوكن في localStorage أو context في الفرونت.
- إذا كانت البيانات خاطئة:
  - يرجع الباك رسالة خطأ موحدة بصيغة JSON (code, http, message).

## 2. إنشاء المستشفى (Hospital Creation)
- عند تسجيل مستخدم جديد، يتم إنشاء سجل مستشفى مرتبط به تلقائيًا.
- كل مستشفى لها خصائص:
  - id, name, level, reputation, cash, soft_currency
  - owner_user_id (يربط المستشفى بالمستخدم)
- يتم إنشاء أقسام افتراضية (مثل ER) للمستشفى.

## 3. عرض بيانات المستشفى والأقسام (Dashboard)
- عند الدخول للواجهة:
  - يتم إرسال طلب GET إلى `/api/hospital` مع توكن المستخدم.
  - يرجع الباك بيانات المستشفى + قائمة الأقسام المرتبطة.
  - كل قسم له خصائص: id, type, level, rooms, beds, base_capacity

## 4. طابور المرضى (ERQueue)
- يتم إرسال طلب GET إلى `/api/patients/queue?dept=ER`.
- الباك يجلب المرضى المرتبطين بالمستشفى، مرتبين حسب:
  - الحالة (status: WAIT, IN_SERVICE, DONE)
  - الأولوية (triage_priority)
- كل مريض له خصائص: id, severity, condition_code, triage_priority, status, wait_since
- يتم عرض الطابور في الواجهة مع إمكانية التفاعل (بدء خدمة، نقل، إلخ).

## 5. قبول مهمة جديدة (Mission Accept)
- يتم إرسال طلب POST إلى `/api/missions/accept` مع كود المهمة.
- الباك ينشئ مهمة جديدة (Mission) ويربطها بالمستشفى.
- يتم توليد مجموعة مرضى جدد (6-8) مرتبطين بالمهمة والمستشفى.
- كل مهمة لها خصائص: id, template_id, status, started_at, ends_at

## 6. تحديث حالة المرضى (Tick Job)
- يتم تشغيل Job دوري (RunTick) عبر الصف (queue).
- يقوم بتحديث حالة المرضى:
  - نقل المرضى من WAIT إلى IN_SERVICE حسب توفر الأسرّة.
  - بعد مدة معينة، يتم نقلهم إلى DONE.
  - يتم تحديث خصائص المريض (status, updated_at).
- يمكن تشغيل الـJob يدويًا أو عبر جدولة الكرون.

## 7. تجميع مؤشرات الأداء (KPIs)
- Job دوري (AggregateKpis) يجمع بيانات الأداء لكل مستشفى يوميًا:
  - متوسط وقت الانتظار (avg_wait_min)
  - عدد المرضى المخدومين (service_rate)
  - نسبة الإشغال (occupancy)
  - رضا المرضى (satisfaction)
- يتم حفظ المؤشرات في جدول KPI لكل مستشفى ولكل يوم.

## 8. حماية المسارات (Sanctum)
- جميع المسارات المحمية تتطلب توكن Bearer في الهيدر.
- إذا انتهت صلاحية التوكن أو كان غير صحيح:
  - يرجع الباك خطأ 401 بصيغة موحدة.
- يتم التحقق من التوكن في كل طلب عبر Middleware.

## 9. معالجة الأخطاء (Error Handling)
- جميع الأخطاء ترجع بصيغة JSON موحدة:
  - code, http, message, fields (لأخطاء التحقق)، trace_id
- الأخطاء الشائعة:
  - 401: انتهاء الجلسة أو بيانات خاطئة
  - 422: تحقق الحقول
  - 500: خطأ غير متوقع

## 10. التوكنات (Tokens)
- يتم إصدار توكن جديد عند تسجيل الدخول.
- يمكن تدوير التوكنات أو إبطالها يدويًا.
- التوكن يستخدم في كل طلب محمي.

## 11. التفاعل بين الواجهة والباك
- كل طلب من الواجهة يرسل توكن في الهيدر.
- يتم التعامل مع الأخطاء عبر Interceptors في الفرونت:
  - 401: تسجيل خروج وتوجيه إلى صفحة الدخول
  - 422: عرض أخطاء الحقول
  - 500+: عرض رسالة عامة
- يتم تحديث البيانات في الواجهة حسب استجابة الـAPI.

## 12. المهمات (Missions)
- كل مهمة لها قالب (MissionTemplate) يحدد نوعها ومدة التنفيذ.
- عند قبول مهمة:
  - يتم توليد مرضى جدد حسب نوع المهمة.
  - يتم ربطهم بالمستشفى والمهمة.
- يمكن عرض المهمات النشطة عبر `/api/missions/active`.

## 13. الأقسام (Departments)
- كل مستشفى تحتوي على أقسام (ER, ICU, إلخ).
- كل قسم له خصائص: نوع، مستوى، عدد الأسرّة، عدد الغرف، الطاقة الاستيعابية.
- يمكن تطوير الأقسام لاحقًا (ترقية، توسعة).

## 14. المرضى (Patients)
- لكل مريض خصائص:
  - شدة الحالة (severity)
  - نوع الإصابة (condition_code)
  - أولوية الفرز (triage_priority)
  - حالة (WAIT, IN_SERVICE, DONE)
  - وقت الانتظار (wait_since)
- يتم تحديث حالة المرضى عبر الـTick Job.

## 15. المؤشرات (KPIs)
- يتم حساب المؤشرات يوميًا لكل مستشفى:
  - متوسط الانتظار
  - عدد المخدومين
  - نسبة الإشغال
  - الرضا
- تستخدم المؤشرات في تقييم أداء المستشفى.

## 16. الموارد (Cash/Soft Currency)
- كل مستشفى لها رصيد نقدي وعملة افتراضية.
- يتم زيادة الرصيد عند خدمة المرضى أو إتمام المهمات.
- يمكن استخدام الموارد في تطوير الأقسام أو شراء معدات.

## 17. التوسعة المستقبلية
- إضافة إدارة الموظفين (Staff): تعيين، توزيع، تقييم.
- دعم SSE/WebSocket لطوابير المرضى الحية.
- نظام إشعارات وأحداث.
- اختبارات تلقائية.
- دعم تعدد اللغات.
- مراقبة الصفوف عبر Horizon.
- توثيق كامل للـAPI.

---

> هذا الملف يوثق منطق اللعبة بالكامل، ويمكن تحديثه مع كل إضافة أو تعديل جديدة.
